# 订单流策略实时交易机器人

这是一个实时跟踪EdgeX交易所并执行订单流策略的自动化交易机器人。

## 功能特点

- ✅ **实时订单簿监控**: 通过WebSocket实时订阅EdgeX订单簿深度数据
- ✅ **订单流分析**: 分析订单簿失衡、交易流方向等指标
- ✅ **自动交易执行**: 根据策略信号自动下单
- ✅ **风险控制**: 内置止损止盈、持仓限制等风险管理
- ✅ **实时日志**: 详细的交易日志和策略状态监控

## 前置要求

1. **Python环境**: Python 3.10+
2. **依赖包**: 安装项目所需的所有依赖
3. **EdgeX账户**: 需要有效的EdgeX账户和API密钥
4. **环境变量**: 配置`.env`文件

## 环境配置

在项目根目录创建`.env`文件，配置以下变量：

```env
EDGEX_ACCOUNT_ID=your_account_id
EDGEX_STARK_PRIVATE_KEY=your_stark_private_key
EDGEX_BASE_URL=https://pro.edgex.exchange
EDGEX_WS_URL=wss://quote.edgex.exchange
```

## 使用方法

### 基本使用

```bash
python booking/run_orderflow_bot.py --exchange edgex --ticker ETH
```

### 完整参数示例

```bash
python booking/run_orderflow_bot.py \
    --exchange edgex \
    --ticker ETH \
    --position-size 0.1 \
    --imbalance-threshold 0.6 \
    --signal-strength-threshold 0.7 \
    --confirmation-ticks 3 \
    --update-interval 0.5 \
    --max-position 1.0 \
    --stop-loss-pct 0.02 \
    --take-profit-pct 0.01 \
    --enable-logging
```

### 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--exchange` | 交易所名称 | `edgex` |
| `--ticker` | 交易对（如ETH, BTC） | `ETH` |
| `--position-size` | 每笔交易的头寸大小 | `0.1` |
| `--imbalance-threshold` | 订单簿失衡阈值（0-1） | `0.6` |
| `--signal-strength-threshold` | 信号强度阈值（0-1） | `0.7` |
| `--confirmation-ticks` | 确认信号所需的连续tick数 | `3` |
| `--update-interval` | 策略更新间隔（秒） | `0.5` |
| `--max-position` | 最大持仓限制 | `1.0` |
| `--stop-loss-pct` | 止损百分比 | `0.02` (2%) |
| `--take-profit-pct` | 止盈百分比 | `0.01` (1%) |
| `--enable-logging` | 启用详细日志 | `False` |

## 策略原理

### 订单流分析

机器人通过以下指标分析市场：

1. **订单簿失衡**: 计算买卖盘口的订单量不平衡程度
2. **加权失衡**: 考虑价格权重的订单簿失衡
3. **交易流方向**: 分析最近一段时间内的交易方向
4. **价格动量**: 检测价格变化趋势

### 信号生成

当以下条件满足时，会生成交易信号：

- 订单簿失衡超过阈值
- 交易流方向与订单簿失衡一致
- 信号强度达到设定阈值
- 连续多个tick确认信号方向

### 风险控制

- **持仓限制**: 限制最大持仓量
- **止损止盈**: 自动设置止损和止盈订单
- **订单频率**: 限制每分钟最大订单数
- **每日亏损限制**: 可设置每日最大亏损（可选）

## 运行示例

```bash
$ python booking/run_orderflow_bot.py --exchange edgex --ticker ETH

================================================================================
订单流策略 - 实时交易机器人
================================================================================

配置:
  - 交易所: edgex
  - 交易对: ETH
  - 头寸大小: 0.1
  - 失衡阈值: 0.6
  - 信号强度阈值: 0.7
  - 确认tick数: 3
  - 更新间隔: 0.5秒

⚠️  警告: 这是实时交易机器人，将使用真实资金进行交易！
按 Ctrl+C 停止机器人
================================================================================

🚀 订单流交易机器人开始运行
交易所: edgex
交易对: ETH
更新间隔: 0.5秒
================================================================================
✅ 机器人初始化成功
合约ID: ETHUSD
✅ WebSocket连接已建立
✅ 已订阅订单簿深度频道: depth.ETHUSD.20
✅ 订单簿数据已就绪
📊 生成信号: BUY @ 2000.50, 强度: 75.00%, 原因: 订单簿买单占优 (失衡: 65.00%)
⏳ 等待信号确认 (1/3)
📊 生成信号: BUY @ 2000.52, 强度: 78.00%, 原因: 订单簿买单占优 (失衡: 68.00%)
⏳ 等待信号确认 (2/3)
📊 生成信号: BUY @ 2000.55, 强度: 80.00%, 原因: 订单簿买单占优 (失衡: 70.00%)
✅ 信号已确认，准备执行
✅ 交易执行成功
```

## 停止机器人

按 `Ctrl+C` 安全停止机器人。机器人会：
1. 停止接收新信号
2. 等待当前订单完成
3. 断开WebSocket连接
4. 保存日志

## 注意事项

⚠️ **重要警告**:

1. **真实资金交易**: 此机器人使用真实资金进行交易，请确保充分理解策略逻辑
2. **测试建议**: 建议先在测试环境或小额资金上测试
3. **参数调整**: 根据市场情况调整策略参数，不同市场可能需要不同的阈值
4. **监控运行**: 运行期间请保持监控，及时发现问题
5. **网络稳定**: 确保网络连接稳定，WebSocket断线会影响策略执行
6. **API限制**: 注意交易所的API调用频率限制

## 故障排除

### WebSocket连接失败

如果WebSocket连接失败，机器人会自动回退到REST API轮询模式：

```
⚠️ WebSocket连接失败，将使用REST API轮询
```

### 订单簿数据未就绪

如果订单簿数据长时间未就绪，检查：
1. WebSocket连接是否正常
2. 合约ID是否正确
3. 网络连接是否稳定

### 交易执行失败

如果交易执行失败，检查：
1. 账户余额是否充足
2. API密钥是否有效
3. 订单参数是否符合交易所要求

## 日志文件

机器人会在 `logs/` 目录下生成日志文件：
- `edgex_ETH_YYYYMMDD.log`: 每日交易日志
- 包含所有交易信号、执行结果和错误信息

## 技术支持

如有问题，请查看：
- 项目主README: `README.md`
- 订单流策略文档: `booking/README.md`
- 回测系统: `booking/BACKTEST_GUIDE.md`

## 许可证

请参考项目根目录的 LICENSE 文件。
